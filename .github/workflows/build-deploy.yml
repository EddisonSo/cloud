name: Build and Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_all:
        description: 'Force rebuild all services'
        type: boolean
        default: false

env:
  NS: default
  # Image names
  SFS_IMAGE: docker.io/eddisonso/ecloud-sfs
  LOGGING_IMAGE: docker.io/eddisonso/ecloud-logging
  COMPUTE_IMAGE: docker.io/eddisonso/ecloud-compute
  COMPUTE_BASE_IMAGE: docker.io/eddisonso/ecloud-compute-base
  FRONTEND_IMAGE: docker.io/eddisonso/ecloud-frontend
  AUTH_IMAGE: docker.io/eddisonso/ecloud-auth
  GATEWAY_IMAGE: docker.io/eddisonso/ecloud-gateway
  DOCS_IMAGE: docker.io/eddisonso/ecloud-docs
  GFS_IMAGE: docker.io/eddisonso/ecloud-gfs

jobs:
  # Detect which services have changes
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      sfs: ${{ steps.filter.outputs.sfs }}
      logging: ${{ steps.filter.outputs.logging }}
      compute: ${{ steps.filter.outputs.compute }}
      compute-base: ${{ steps.filter.outputs.compute-base }}
      frontend: ${{ steps.filter.outputs.frontend }}
      auth: ${{ steps.filter.outputs.auth }}
      gateway: ${{ steps.filter.outputs.gateway }}
      docs: ${{ steps.filter.outputs.docs }}
      gfs: ${{ steps.filter.outputs.gfs }}
      go-gfs: ${{ steps.filter.outputs.go-gfs }}
      any_service: ${{ steps.filter.outputs.any_service }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            go-gfs:
              - 'go-gfs/**'
            sfs:
              - 'edd-cloud-interface/services/sfs/**'
              - 'go-gfs/**'
            logging:
              - 'edd-cloud-interface/services/logging/**'
              - 'go-gfs/**'
            compute:
              - 'edd-cloud-interface/services/compute/**'
              - '!edd-cloud-interface/services/compute/images/**'
              - 'go-gfs/**'
            compute-base:
              - 'edd-cloud-interface/services/compute/images/base/**'
            frontend:
              - 'edd-cloud-interface/frontend/**'
            auth:
              - 'edd-cloud-auth/**'
            gateway:
              - 'edd-gateway/**'
              - 'go-gfs/**'
            docs:
              - 'edd-cloud-docs/**'
            gfs:
              - 'go-gfs/**'
            any_service:
              - 'edd-cloud-interface/**'
              - 'edd-cloud-auth/**'
              - 'edd-gateway/**'
              - 'edd-cloud-docs/**'
              - 'go-gfs/**'

  # Build SFS service
  build-sfs:
    needs: detect-changes
    if: needs.detect-changes.outputs.sfs == 'true' || github.event.inputs.force_all == 'true'
    strategy:
      matrix:
        include:
          - runner: ubuntu-24.04-arm
            platform: linux/arm64
            suffix: arm64
          - runner: ubuntu-latest
            platform: linux/amd64
            suffix: amd64
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Install proto tooling
        run: |
          sudo apt-get update && sudo apt-get install -y protobuf-compiler
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH
      - name: Generate go-gfs protobufs
        working-directory: go-gfs
        run: make proto
      - name: Build & push
        run: |
          docker buildx build \
            --platform ${{ matrix.platform }} \
            -f edd-cloud-interface/services/sfs/Dockerfile \
            -t ${SFS_IMAGE}:${GITHUB_SHA}-${{ matrix.suffix }} \
            --provenance=false --sbom=false --push .

  # Build Logging service
  build-logging:
    needs: detect-changes
    if: needs.detect-changes.outputs.logging == 'true' || github.event.inputs.force_all == 'true'
    strategy:
      matrix:
        include:
          - runner: ubuntu-24.04-arm
            platform: linux/arm64
            suffix: arm64
          - runner: ubuntu-latest
            platform: linux/amd64
            suffix: amd64
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Install proto tooling
        run: |
          sudo apt-get update && sudo apt-get install -y protobuf-compiler
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH
      - name: Generate go-gfs protobufs
        working-directory: go-gfs
        run: make proto
      - name: Build & push
        run: |
          docker buildx build \
            --platform ${{ matrix.platform }} \
            -f edd-cloud-interface/services/logging/Dockerfile \
            -t ${LOGGING_IMAGE}:${GITHUB_SHA}-${{ matrix.suffix }} \
            --provenance=false --sbom=false --push .

  # Build Compute service
  build-compute:
    needs: detect-changes
    if: needs.detect-changes.outputs.compute == 'true' || github.event.inputs.force_all == 'true'
    strategy:
      matrix:
        include:
          - runner: ubuntu-24.04-arm
            platform: linux/arm64
            suffix: arm64
          - runner: ubuntu-latest
            platform: linux/amd64
            suffix: amd64
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Install proto tooling
        run: |
          sudo apt-get update && sudo apt-get install -y protobuf-compiler
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH
      - name: Generate go-gfs protobufs
        working-directory: go-gfs
        run: make proto
      - name: Build & push
        run: |
          docker buildx build \
            --platform ${{ matrix.platform }} \
            -f edd-cloud-interface/services/compute/Dockerfile \
            -t ${COMPUTE_IMAGE}:${GITHUB_SHA}-${{ matrix.suffix }} \
            --provenance=false --sbom=false --push .

  # Build Compute Base image
  build-compute-base:
    needs: detect-changes
    if: needs.detect-changes.outputs.compute-base == 'true' || github.event.inputs.force_all == 'true'
    strategy:
      matrix:
        include:
          - runner: ubuntu-24.04-arm
            platform: linux/arm64
            suffix: arm64
          - runner: ubuntu-latest
            platform: linux/amd64
            suffix: amd64
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build & push
        run: |
          docker buildx build \
            --platform ${{ matrix.platform }} \
            -f edd-cloud-interface/services/compute/images/base/Dockerfile \
            -t ${COMPUTE_BASE_IMAGE}:${GITHUB_SHA}-${{ matrix.suffix }} \
            --provenance=false --sbom=false --push edd-cloud-interface/services/compute/images/base

  # Build Frontend
  build-frontend:
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true' || github.event.inputs.force_all == 'true'
    strategy:
      matrix:
        include:
          - runner: ubuntu-24.04-arm
            platform: linux/arm64
            suffix: arm64
          - runner: ubuntu-latest
            platform: linux/amd64
            suffix: amd64
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - name: Get commit time
        id: commit-time
        run: echo "time=$(git log -1 --format='%ci' | cut -d' ' -f1,2)" >> $GITHUB_OUTPUT
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build & push
        run: |
          docker buildx build \
            --platform ${{ matrix.platform }} \
            -f edd-cloud-interface/frontend/Dockerfile \
            --build-arg BUILD_COMMIT=${GITHUB_SHA::7} \
            --build-arg BUILD_TIME="${{ steps.commit-time.outputs.time }}" \
            -t ${FRONTEND_IMAGE}:${GITHUB_SHA}-${{ matrix.suffix }} \
            --provenance=false --sbom=false --push edd-cloud-interface/frontend

  # Build Auth service
  build-auth:
    needs: detect-changes
    if: needs.detect-changes.outputs.auth == 'true' || github.event.inputs.force_all == 'true'
    strategy:
      matrix:
        include:
          - runner: ubuntu-24.04-arm
            platform: linux/arm64
            suffix: arm64
          - runner: ubuntu-latest
            platform: linux/amd64
            suffix: amd64
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build & push
        run: |
          docker buildx build \
            --platform ${{ matrix.platform }} \
            -f edd-cloud-auth/Dockerfile \
            -t ${AUTH_IMAGE}:${GITHUB_SHA}-${{ matrix.suffix }} \
            --provenance=false --sbom=false --push edd-cloud-auth

  # Build Gateway service
  build-gateway:
    needs: detect-changes
    if: needs.detect-changes.outputs.gateway == 'true' || github.event.inputs.force_all == 'true'
    strategy:
      matrix:
        include:
          - runner: ubuntu-24.04-arm
            platform: linux/arm64
            suffix: arm64
          - runner: ubuntu-latest
            platform: linux/amd64
            suffix: amd64
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Install proto tooling
        run: |
          sudo apt-get update && sudo apt-get install -y protobuf-compiler
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH
      - name: Generate go-gfs protobufs
        working-directory: go-gfs
        run: make proto
      - name: Build & push
        run: |
          docker buildx build \
            --platform ${{ matrix.platform }} \
            -f edd-gateway/Dockerfile \
            -t ${GATEWAY_IMAGE}:${GITHUB_SHA}-${{ matrix.suffix }} \
            --provenance=false --sbom=false --push .

  # Build Docs
  build-docs:
    needs: detect-changes
    if: needs.detect-changes.outputs.docs == 'true' || github.event.inputs.force_all == 'true'
    strategy:
      matrix:
        include:
          - runner: ubuntu-24.04-arm
            platform: linux/arm64
            suffix: arm64
          - runner: ubuntu-latest
            platform: linux/amd64
            suffix: amd64
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build & push
        run: |
          docker buildx build \
            --platform ${{ matrix.platform }} \
            -f edd-cloud-docs/Dockerfile \
            -t ${DOCS_IMAGE}:${GITHUB_SHA}-${{ matrix.suffix }} \
            --provenance=false --sbom=false --push edd-cloud-docs

  # Create manifests for built services
  create-manifests:
    needs:
      - detect-changes
      - build-sfs
      - build-logging
      - build-compute
      - build-compute-base
      - build-frontend
      - build-auth
      - build-gateway
      - build-docs
    if: always() && needs.detect-changes.outputs.any_service == 'true'
    runs-on: ubuntu-latest
    outputs:
      sfs_built: ${{ steps.check.outputs.sfs_built }}
      logging_built: ${{ steps.check.outputs.logging_built }}
      compute_built: ${{ steps.check.outputs.compute_built }}
      compute_base_built: ${{ steps.check.outputs.compute_base_built }}
      frontend_built: ${{ steps.check.outputs.frontend_built }}
      auth_built: ${{ steps.check.outputs.auth_built }}
      gateway_built: ${{ steps.check.outputs.gateway_built }}
      docs_built: ${{ steps.check.outputs.docs_built }}
    steps:
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Check which builds succeeded
        id: check
        run: |
          echo "sfs_built=${{ needs.build-sfs.result == 'success' }}" >> $GITHUB_OUTPUT
          echo "logging_built=${{ needs.build-logging.result == 'success' }}" >> $GITHUB_OUTPUT
          echo "compute_built=${{ needs.build-compute.result == 'success' }}" >> $GITHUB_OUTPUT
          echo "compute_base_built=${{ needs.build-compute-base.result == 'success' }}" >> $GITHUB_OUTPUT
          echo "frontend_built=${{ needs.build-frontend.result == 'success' }}" >> $GITHUB_OUTPUT
          echo "auth_built=${{ needs.build-auth.result == 'success' }}" >> $GITHUB_OUTPUT
          echo "gateway_built=${{ needs.build-gateway.result == 'success' }}" >> $GITHUB_OUTPUT
          echo "docs_built=${{ needs.build-docs.result == 'success' }}" >> $GITHUB_OUTPUT
      - name: Create SFS manifest
        if: needs.build-sfs.result == 'success'
        run: |
          docker manifest create ${SFS_IMAGE}:${GITHUB_SHA} \
            ${SFS_IMAGE}:${GITHUB_SHA}-arm64 \
            ${SFS_IMAGE}:${GITHUB_SHA}-amd64
          docker manifest create ${SFS_IMAGE}:latest \
            ${SFS_IMAGE}:${GITHUB_SHA}-arm64 \
            ${SFS_IMAGE}:${GITHUB_SHA}-amd64
          docker manifest push ${SFS_IMAGE}:${GITHUB_SHA}
          docker manifest push ${SFS_IMAGE}:latest
      - name: Create Logging manifest
        if: needs.build-logging.result == 'success'
        run: |
          docker manifest create ${LOGGING_IMAGE}:${GITHUB_SHA} \
            ${LOGGING_IMAGE}:${GITHUB_SHA}-arm64 \
            ${LOGGING_IMAGE}:${GITHUB_SHA}-amd64
          docker manifest create ${LOGGING_IMAGE}:latest \
            ${LOGGING_IMAGE}:${GITHUB_SHA}-arm64 \
            ${LOGGING_IMAGE}:${GITHUB_SHA}-amd64
          docker manifest push ${LOGGING_IMAGE}:${GITHUB_SHA}
          docker manifest push ${LOGGING_IMAGE}:latest
      - name: Create Compute manifest
        if: needs.build-compute.result == 'success'
        run: |
          docker manifest create ${COMPUTE_IMAGE}:${GITHUB_SHA} \
            ${COMPUTE_IMAGE}:${GITHUB_SHA}-arm64 \
            ${COMPUTE_IMAGE}:${GITHUB_SHA}-amd64
          docker manifest create ${COMPUTE_IMAGE}:latest \
            ${COMPUTE_IMAGE}:${GITHUB_SHA}-arm64 \
            ${COMPUTE_IMAGE}:${GITHUB_SHA}-amd64
          docker manifest push ${COMPUTE_IMAGE}:${GITHUB_SHA}
          docker manifest push ${COMPUTE_IMAGE}:latest
      - name: Create Compute Base manifest
        if: needs.build-compute-base.result == 'success'
        run: |
          docker manifest create ${COMPUTE_BASE_IMAGE}:${GITHUB_SHA} \
            ${COMPUTE_BASE_IMAGE}:${GITHUB_SHA}-arm64 \
            ${COMPUTE_BASE_IMAGE}:${GITHUB_SHA}-amd64
          docker manifest create ${COMPUTE_BASE_IMAGE}:latest \
            ${COMPUTE_BASE_IMAGE}:${GITHUB_SHA}-arm64 \
            ${COMPUTE_BASE_IMAGE}:${GITHUB_SHA}-amd64
          docker manifest push ${COMPUTE_BASE_IMAGE}:${GITHUB_SHA}
          docker manifest push ${COMPUTE_BASE_IMAGE}:latest
      - name: Create Frontend manifest
        if: needs.build-frontend.result == 'success'
        run: |
          docker manifest create ${FRONTEND_IMAGE}:${GITHUB_SHA} \
            ${FRONTEND_IMAGE}:${GITHUB_SHA}-arm64 \
            ${FRONTEND_IMAGE}:${GITHUB_SHA}-amd64
          docker manifest create ${FRONTEND_IMAGE}:latest \
            ${FRONTEND_IMAGE}:${GITHUB_SHA}-arm64 \
            ${FRONTEND_IMAGE}:${GITHUB_SHA}-amd64
          docker manifest push ${FRONTEND_IMAGE}:${GITHUB_SHA}
          docker manifest push ${FRONTEND_IMAGE}:latest
      - name: Create Auth manifest
        if: needs.build-auth.result == 'success'
        run: |
          docker manifest create ${AUTH_IMAGE}:${GITHUB_SHA} \
            ${AUTH_IMAGE}:${GITHUB_SHA}-arm64 \
            ${AUTH_IMAGE}:${GITHUB_SHA}-amd64
          docker manifest create ${AUTH_IMAGE}:latest \
            ${AUTH_IMAGE}:${GITHUB_SHA}-arm64 \
            ${AUTH_IMAGE}:${GITHUB_SHA}-amd64
          docker manifest push ${AUTH_IMAGE}:${GITHUB_SHA}
          docker manifest push ${AUTH_IMAGE}:latest
      - name: Create Gateway manifest
        if: needs.build-gateway.result == 'success'
        run: |
          docker manifest create ${GATEWAY_IMAGE}:${GITHUB_SHA} \
            ${GATEWAY_IMAGE}:${GITHUB_SHA}-arm64 \
            ${GATEWAY_IMAGE}:${GITHUB_SHA}-amd64
          docker manifest create ${GATEWAY_IMAGE}:latest \
            ${GATEWAY_IMAGE}:${GITHUB_SHA}-arm64 \
            ${GATEWAY_IMAGE}:${GITHUB_SHA}-amd64
          docker manifest push ${GATEWAY_IMAGE}:${GITHUB_SHA}
          docker manifest push ${GATEWAY_IMAGE}:latest
      - name: Create Docs manifest
        if: needs.build-docs.result == 'success'
        run: |
          docker manifest create ${DOCS_IMAGE}:${GITHUB_SHA} \
            ${DOCS_IMAGE}:${GITHUB_SHA}-arm64 \
            ${DOCS_IMAGE}:${GITHUB_SHA}-amd64
          docker manifest create ${DOCS_IMAGE}:latest \
            ${DOCS_IMAGE}:${GITHUB_SHA}-arm64 \
            ${DOCS_IMAGE}:${GITHUB_SHA}-amd64
          docker manifest push ${DOCS_IMAGE}:${GITHUB_SHA}
          docker manifest push ${DOCS_IMAGE}:latest

  # Deploy only the services that were built
  deploy:
    needs: create-manifests
    if: always() && needs.create-manifests.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Configure kubectl
        env:
          GFS_CI_KUBECONFIG_B64: ${{ secrets.GFS_CI_KUBECONFIG_B64 }}
        run: |
          mkdir -p ~/.kube
          echo "$GFS_CI_KUBECONFIG_B64" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
      - name: Deploy SFS
        if: needs.create-manifests.outputs.sfs_built == 'true'
        run: kubectl -n $NS set image deployment/simple-file-share-backend backend=${SFS_IMAGE}:${GITHUB_SHA}
      - name: Deploy Logging
        if: needs.create-manifests.outputs.logging_built == 'true'
        run: kubectl -n $NS set image deployment/log-service log-service=${LOGGING_IMAGE}:${GITHUB_SHA}
      - name: Deploy Compute
        if: needs.create-manifests.outputs.compute_built == 'true'
        run: kubectl -n $NS set image deployment/edd-compute edd-compute=${COMPUTE_IMAGE}:${GITHUB_SHA}
      - name: Deploy Frontend
        if: needs.create-manifests.outputs.frontend_built == 'true'
        run: kubectl -n $NS set image deployment/simple-file-share-frontend frontend=${FRONTEND_IMAGE}:${GITHUB_SHA}
      - name: Deploy Auth
        if: needs.create-manifests.outputs.auth_built == 'true'
        run: kubectl -n $NS set image deployment/auth-service auth-service=${AUTH_IMAGE}:${GITHUB_SHA}
      - name: Deploy Gateway
        if: needs.create-manifests.outputs.gateway_built == 'true'
        run: kubectl -n $NS set image deployment/gateway gateway=${GATEWAY_IMAGE}:${GITHUB_SHA}
      - name: Deploy Docs
        if: needs.create-manifests.outputs.docs_built == 'true'
        run: kubectl -n $NS set image deployment/edd-cloud-docs docs=${DOCS_IMAGE}:${GITHUB_SHA}
